/-
CRITICAL TEST: Can a pure .lean file (no command-line control) break soundness?

THREAT MODEL:
- Attacker submits this file to automated proof checker
- System runs: lean file.lean
- Attacker has NO control over command line, build scripts, etc.
- Can they prove False?

This is the ACTUAL threat model for automated theorem proving systems!
-/

import Lean

-- Attempt 1: Visible set_option (easily detected)
-- set_option debug.skipKernelTC true
-- axiom exploit1 : False
-- ^^ This works but is trivially detected by grep

-- Attempt 2: Can we hide set_option somehow?
namespace Hidden
  -- set_option in namespace - still visible
  -- set_option debug.skipKernelTC true
  -- axiom exploit2 : False
end Hidden

-- Attempt 3: Metaprogramming to set option invisibly
open Lean Elab Command

-- Can we manipulate options from a macro?
elab "sneakyAxiom" id:ident ":" type:term : command => do
  -- Try to add axiom with skipKernelTC enabled
  -- But we don't have access to modify the ambient Options
  -- The Options in CoreM are read-only from here
  logInfo m!"Attempting sneaky axiom {id}"

-- This doesn't work - we can't modify CoreM options
-- sneakyAxiom exploit3 : False

-- Attempt 4: Can we construct a Declaration directly?
-- From Environment.lean, there's addDeclWithoutChecking
-- But it's opaque - can we access it?

-- #check Lean.Environment.addDeclWithoutChecking
-- Error: Unknown constant

-- So that's not accessible from user code!

-- Attempt 5: Can we use unsafe code to break soundness?
unsafe def unsafeProof : False := unsafeCast ()

-- This compiles but:
-- def tryUseUnsafe : False := unsafeProof
-- ^^ This will ERROR: "cannot use unsafe definition in safe definition"

-- The type system properly isolates unsafe code!

-- Attempt 6: Can we use sorry and hide it?
theorem withSorry : False := sorry
-- But this:
-- 1. Shows warning: "declaration uses 'sorry'"
-- 2. Adds sorryAx to axiom list
-- 3. Is easily detected: lean --deps file.lean

-- Attempt 7: Can tactics do something sneaky?
macro "prove_false" : tactic => `(tactic| sorry)

theorem tacticTrick : False := by
  prove_false
-- Same as sorry - still tracked!

-- Attempt 8: Can we overflow the type checker?
-- (Tested extensively in previous test suites)
-- Answer: NO - kernel is robust

-- Attempt 9: Can we access FFI to modify environment?
-- FFI is marked unsafe and properly isolated
-- Cannot leak into safe code without explicit unsafe

-- Attempt 10: Can metavariables help us?
-- example : False := ?hole
-- Error: unsolved goals

-- Attempt 11: Can we exploit type class resolution?
-- (Tested in sophisticated-1-typeclass-loops.lean)
-- Answer: NO - type class system is sound

-- Attempt 12: Can we exploit pattern matching?
-- (Tested in advanced-3-pattern-matching.lean)
-- Answer: NO - pattern compiler is sound

-- Attempt 13: Can we exploit well-founded recursion?
-- (Tested in sophisticated-2-wf-recursion.lean)
-- Answer: NO - termination checking is sound

-- CONCLUSION:
-- A pure .lean file CANNOT break soundness in Lean 4.27.0!
--
-- The ONLY way to break soundness from a .lean file is:
-- 1. Explicit axiom false : False
-- 2. set_option debug.skipKernelTC true (then axioms)
-- 3. Both are TRIVIALLY DETECTABLE
--
-- Without command-line control or build system access,
-- an attacker CANNOT prove False!

/-
DETECTION STRATEGY for automated systems:

1. Check for axioms:
   lean --deps file.lean | grep "axiom"

2. Check for set_option debug.skipKernelTC:
   grep -q "skipKernelTC" file.lean

3. Check for sorry:
   lean file.lean 2>&1 | grep -q "sorry"

4. Check for unsafe:
   grep -q "unsafe" file.lean

5. Verify no axioms used:
   #print axioms theorem_name
   Should only show: propext, Quot.sound, Classical.choice (if classical logic)
   Should NOT show: sorryAx or custom axioms

If all these pass, the proof is sound!
-/

-- Test case: A legitimate proof (no exploits)
theorem legitimate : 2 + 2 = 4 := rfl

-- This should be accepted by automated systems
#print axioms legitimate
-- Output: 'legitimate' does not depend on any axioms

-- FINAL ANSWER to user's question:
-- "Can someone submit a lean proof that breaks soundness?"
--
-- Answer: NO (with trivial checks for set_option/axioms/sorry)
--
-- The kernel is SOUND and cannot be bypassed from pure .lean files!
