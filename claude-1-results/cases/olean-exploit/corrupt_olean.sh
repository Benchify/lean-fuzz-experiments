#!/bin/bash
# Craft malicious .olean files

set -e

ORIG="/Users/maxvonhippel/projects/research/lean-fuzz/claude-1-results/cases/olean-exploit/test_source.olean"
DIR="/Users/maxvonhippel/projects/research/lean-fuzz/claude-1-results/cases/olean-exploit"

echo "=== .olean File Corruption Tests ==="

# Test 1: Modify version string
echo -e "\n[Test 1] Version string corruption"
cp "$ORIG" "$DIR/corrupt_version.olean"
# Change version to 9.99.9
echo -n "9.99.9" | dd of="$DIR/corrupt_version.olean" bs=1 seek=8 conv=notrunc 2>/dev/null
echo "Created: corrupt_version.olean"

# Test 2: Corrupt commit hash
echo -e "\n[Test 2] Commit hash corruption"
cp "$ORIG" "$DIR/corrupt_hash.olean"
dd if=/dev/urandom of="$DIR/corrupt_hash.olean" bs=1 count=40 seek=40 conv=notrunc 2>/dev/null
echo "Created: corrupt_hash.olean"

# Test 3: Flip bits in data section
echo -e "\n[Test 3] Data section bit flips"
cp "$ORIG" "$DIR/corrupt_data.olean"
# Flip byte at offset 0x100 (in data section)
printf '\xFF' | dd of="$DIR/corrupt_data.olean" bs=1 count=1 seek=256 conv=notrunc 2>/dev/null
echo "Created: corrupt_data.olean"

# Test 4: Truncate file
echo -e "\n[Test 4] Truncated file"
head -c 100 "$ORIG" > "$DIR/truncated.olean"
echo "Created: truncated.olean"

# Test 5: Append garbage
echo -e "\n[Test 5] Append garbage data"
cp "$ORIG" "$DIR/append_garbage.olean"
dd if=/dev/urandom bs=1024 count=1 >> "$DIR/append_garbage.olean" 2>/dev/null
echo "Created: append_garbage.olean"

# Test 6: Zero out sections
echo -e "\n[Test 6] Zero out middle section"
cp "$ORIG" "$DIR/zeroed.olean"
dd if=/dev/zero of="$DIR/zeroed.olean" bs=1 count=64 seek=128 conv=notrunc 2>/dev/null
echo "Created: zeroed.olean"

# Test 7: Swap bytes to confuse parser
echo -e "\n[Test 7] Byte order corruption"
cp "$ORIG" "$DIR/swapped.olean"
# Swap some bytes
dd if="$DIR/swapped.olean" bs=1 skip=100 count=4 2>/dev/null | \
  tac | dd of="$DIR/swapped.olean" bs=1 seek=100 conv=notrunc 2>/dev/null
echo "Created: swapped.olean"

# Test 8: Inject shellcode-like patterns
echo -e "\n[Test 8] Inject suspicious byte patterns"
cp "$ORIG" "$DIR/shellcode.olean"
# NOP sled + shellcode signature
printf '\x90\x90\x90\x90\xCC\xCC\xCC\xCC' | dd of="$DIR/shellcode.olean" bs=1 seek=200 conv=notrunc 2>/dev/null
echo "Created: shellcode.olean"

echo -e "\n=== Corruption complete ==="
ls -lh "$DIR"/*.olean
