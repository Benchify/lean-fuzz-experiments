-- Thread Safety and Concurrency Vulnerabilities

import Lean

-- Test 1: Concurrent IO operations
def concurrentIO : IO Unit := do
  IO.println "Testing concurrent IO..."

  -- Create multiple tasks
  let task1 := IO.asTask (do
    for i in [0:1000] do
      IO.println s!"Task 1: {i}"
    pure ())

  let task2 := IO.asTask (do
    for i in [0:1000] do
      IO.println s!"Task 2: {i}"
    pure ())

  -- Wait for completion
  let _ ← IO.wait task1
  let _ ← IO.wait task2

  IO.println "Concurrent IO complete"

#eval concurrentIO

-- Test 2: Shared mutable state
def sharedStateRace : IO Unit := do
  IO.println "Testing shared state race..."

  -- Create mutable reference
  let counter ← IO.mkRef 0

  -- Two tasks incrementing the same counter
  let task1 := IO.asTask (do
    for _ in [0:10000] do
      let val ← counter.get
      counter.set (val + 1)
    pure ())

  let task2 := IO.asTask (do
    for _ in [0:10000] do
      let val ← counter.get
      counter.set (val + 1)
    pure ())

  let _ ← IO.wait task1
  let _ ← IO.wait task2

  let final ← counter.get
  IO.println s!"Final counter: {final} (expected: 20000, got race?)"

#eval sharedStateRace

-- Test 3: File system race condition
def fileSystemRace : IO Unit := do
  IO.println "Testing file system race..."

  let filename := "/tmp/lean_race_test.txt"

  -- Task 1: Write file
  let task1 := IO.asTask (do
    for i in [0:100] do
      IO.FS.writeFile filename s!"Task1: {i}\n"
    pure ())

  -- Task 2: Read file
  let task2 := IO.asTask (do
    for _ in [0:100] do
      try
        let content ← IO.FS.readFile filename
        IO.println s!"Read: {content.take 50}"
      catch _ =>
        pure ()
    pure ())

  let _ ← IO.wait task1
  let _ ← IO.wait task2

  IO.println "File race complete"

#eval fileSystemRace

def main : IO Unit := do
  IO.println "=== Thread Safety Tests ==="
  concurrentIO
  sharedStateRace
  fileSystemRace
